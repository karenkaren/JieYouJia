//
//  BoundBankCardController.m
//  LingTouNiaoZF
//
//  Created by LiuFeifei on 16/12/5.
//  Copyright © 2016年 LiuJie. All rights reserved.
//

#import "BoundBankCardController.h"
#import "TextFieldCell.h"
#import "SingleActionSheetPicker.h"
#import "TableViewDevider.h"
#import "MessageCodeController.h"

#define kTextFieldCell @"textFieldCell"

@interface BoundBankCardController ()<UITableViewDataSource, UITableViewDelegate>

@property (nonatomic, strong) UITableView * tableView;
@property (nonatomic, strong) NSArray * data;
@property (nonatomic, strong) NSMutableDictionary * boundBankCardDic;
@property (nonatomic, strong) UIButton * submitButton;

@end

@implementation BoundBankCardController

- (void)viewDidLoad {
    [super viewDidLoad];
    self.title = @"实名绑卡";
    
    [self initBoundBankCardDic];
    [self initData];
    [self initTableView];
    [self initHeaderView];
    [self initFooterView];
    [self registerCells];
}

- (void)initBoundBankCardDic
{
    if (!self.boundBankCardDic) {
        self.boundBankCardDic = [NSMutableDictionary dictionaryWithCapacity:5];
    }
    // todo:判断名字、身份证是否为空
    [self.boundBankCardDic setObject:@"欧詹" forKey:kRealName];
    [self.boundBankCardDic setObject:@"140603198102159215" forKey:kIDCardNo];
}

- (void)initData
{
    self.data = @[
                     @{@"title":@"持卡人姓名：",
                       @"key":kRealName,
                       @"canEdit":[self.boundBankCardDic valueForKey:kRealName] ? @(NO) : @(YES),
                       @"showAccess":@(NO),
                       @"placeholder":@"请输入持卡人姓名",
                       @"maxLength":@(100),
                       },
                     @{@"title":@"身份证号码：",
                       @"key":kIDCardNo,
                       @"canEdit":[self.boundBankCardDic valueForKey:kIDCardNo] ? @(NO) : @(YES),
                       @"showAccess":@(NO),
                       @"placeholder":@"请输入身份证号码",
                       @"maxLength":@(100),
                       },
                     @{@"title":@"选 择 银 行：",
                       @"key":kBankName,
                       @"canEdit":@(NO),
                       @"showAccess":@(YES),
                       @"placeholder":@"请选择银行",
                       @"maxLength":@(100),
                       },
                     @{@"title":@"银行卡卡号：",
                       @"key":kBankCardNo,
                       @"canEdit":@(YES),
                       @"showAccess":@(NO),
                       @"placeholder":@"请输入银行卡卡号",
                       @"maxLength":@(100),
                       },
                     @{@"title":@"银行手机号：",
                       @"key":kBankPhoneNo,
                       @"canEdit":@(YES),
                       @"showAccess":@(NO),
                       @"placeholder":@"请输入银行卡预留的手机号",
                       @"maxLength":@(11),
                       }
                     ];
}

- (void)initTableView
{
    self.tableView = [[UITableView alloc] initWithFrame:CGRectMake(0, 0, self.view.width, self.view.height - kNavigationBarHeight - kStatusBarHeight) style:UITableViewStylePlain];
    self.tableView.backgroundColor = [UIColor whiteColor];
    self.tableView.separatorStyle = UITableViewCellSeparatorStyleSingleLine;
    self.tableView.separatorColor = kLineColorD8D8D8;
    self.tableView.sectionFooterHeight = 0;
    self.tableView.dataSource = self;
    self.tableView.delegate = self;
    [self.view addSubview:self.tableView];
    
    if ([self.tableView respondsToSelector:@selector(setSeparatorInset:)]) {
        [self.tableView setSeparatorInset:UIEdgeInsetsMake(0, kCommonMargin, 0, kCommonMargin)];
    }
    
    if ([self.tableView respondsToSelector:@selector(setLayoutMargins:)]) {
        [self.tableView setLayoutMargins:UIEdgeInsetsMake(0, kCommonMargin, 0, kCommonMargin)];
    }
}

- (void)tableView:(UITableView *)tableView willDisplayCell:(UITableViewCell *)cell forRowAtIndexPath:(NSIndexPath *)indexPath
{
    if ([cell respondsToSelector:@selector(setSeparatorInset:)]) {
        [cell setSeparatorInset:UIEdgeInsetsMake(0, kCommonMargin, 0, kCommonMargin)];
    }
    
    if ([cell respondsToSelector:@selector(setLayoutMargins:)]) {
        [cell setLayoutMargins:UIEdgeInsetsMake(0, kCommonMargin, 0, kCommonMargin)];
    }
}

- (void)initHeaderView
{
    UIView * headerView = [TableViewDevider getViewWithHeight:40 margin:kCommonMargin showTopLine:NO showBottomLine:YES];
    
    UILabel * headerLabel = [[UILabel alloc] init];
    headerLabel.text = @"*请绑定持卡人本人名下的银行卡";
    [headerLabel sizeToFit];
    headerLabel.font = kFont12;
    headerLabel.textColor = kHexColor(0x444444);
    [headerView addSubview:headerLabel];
    
    [headerLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.equalTo(headerView).offset(kCommonMargin);
        make.centerY.equalTo(headerView);
    }];
    self.tableView.tableHeaderView = headerView;
}

- (void)initFooterView
{
    UIView * footerView = [TableViewDevider getViewWithHeight:kAdaptiveBaseIphone6(95) margin:kCommonMargin showTopLine:YES showBottomLine:NO];
    UIButton * submitButton = [CustomButton createMiddleBGButtonWithTitle:@"下一步" actionBolck:^(UIButton *button) {
        DLog(@"下一步");
        [self submitClick:button];
    }];
    submitButton.enabled = NO;
    [footerView addSubview:submitButton];
    [submitButton mas_makeConstraints:^(MASConstraintMaker *make) {
        make.center.equalTo(footerView);
    }];
    
    self.tableView.tableFooterView = footerView;
    self.submitButton = submitButton;
}

- (void)registerCells
{
    [self.tableView registerClass:[TextFieldCell class] forCellReuseIdentifier:kTextFieldCell];
}

- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView
{
    return 1;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return self.data.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    
    TextFieldCell *cell = [tableView dequeueReusableCellWithIdentifier:kTextFieldCell];
    cell.selectionStyle = UITableViewCellSelectionStyleNone;
    NSMutableDictionary *dic = [self.data[indexPath.row] mutableCopy];
    NSString * contentText = _boundBankCardDic[dic[@"key"]];
    cell.textField.text = contentText;
    cell.cellDic = dic;
    cell.textFieldTextChangeBlock=^(NSString *text){
        if ([text isEqualToString:@""]) {
            [self.boundBankCardDic removeObjectForKey:dic[@"key"]];
        } else {
            [self.boundBankCardDic setValue:text forKey:dic[@"key"]];
        }
        [self detectIntegrity];
    };
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath {
    NSDictionary *dic = self.data[indexPath.row];
    if([dic[@"key"] isEqualToString:kBankName]){
        kWeakSelf
        NSArray * array = @[@"中国银行", @"工商银行", @"农业银行", @"北京银行", @"建设银行", @"宁波银行", @"光大银行", @"杭州银行"];
        NSMutableArray * array1 = [NSMutableArray arrayWithCapacity:array.count];
        for (NSString * string in array) {
            NSMutableDictionary * dic = [NSMutableDictionary dictionaryWithCapacity:1];
            [dic setObject:string forKey:@"key"];
            [dic setObject:string forKey:@"value"];
            [array1 addObject:dic];
        }
        [SingleActionSheetPicker showWithTitle:dic[@"title"]                                       selectArray:array1
                            initialSelectedDic:@{@"key" : @"中国银行"}
                                          done:^(RootActionSheetPicker *picker, NSDictionary *selectedDic) {
                                              kStrongSelf
                                              [strongSelf.boundBankCardDic setObject:selectedDic[@"key"] forKey:dic[@"key"]];
                                              [strongSelf.tableView reloadData];
                                              [self detectIntegrity];
                                          }
                                        origin:self.view];
    }
}

- (void)detectIntegrity
{
    if (self.boundBankCardDic.count == self.data.count) {
        self.submitButton.enabled = YES;
    } else {
        self.submitButton.enabled = NO;
    }
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    return kTextFieldCellHeight;
}

- (void)submitClick:(UIButton *)button
{
    DLog(@"下一步");
    MessageCodeController * messageCodeController = [[MessageCodeController alloc] init];
    messageCodeController.params = self.boundBankCardDic;
    [self.navigationController pushViewController:messageCodeController animated:YES];
}

@end
