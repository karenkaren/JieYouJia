//
//  HomeRootController.m
//  LingTouNiaoZF
//
//  Created by LiuFeifei on 16/11/24.
//  Copyright © 2016年 LiuJie. All rights reserved.
//

#import "HomeRootController.h"
#import "UserLoginController.h"
#import "BaseNavigationController.h"
#import "BoundBankCardController.h"

#import "MessageRemindView.h"
#import "RegionSelectView.h"
#import "BannerView.h"
#import "HomeHeaderView.h"
#import "HomeSectionHeaderView.h"

#import "HomeActivityCell.h"
#import "HomeRecommentCell.h"
#import "HomeApartmentCell.h"

#import "RecommendBanner.h"

#define kHomeActivityCell @"HomeActivityCell"
#define kHomeRecommentCell @"HomeRecommentCell"
#define kHomeApartmentCell @"HomeApartmentCell"

#import "HomeModel.h"
#import "SortModel.h"
#import "RecommendBanner.h"
#import "ApartmentModel.h"

@interface HomeRootController ()<UITableViewDataSource, UITableViewDelegate, HomeSectionHeaderViewDelegate, BaseBannerCellDelegate>

@property (nonatomic, strong) MessageRemindView * messageRemindView;
@property (nonatomic, strong) HomeHeaderView * homeHeaderView;
@property (nonatomic, strong) UITableView * tableView;
@property (nonatomic, strong) NSMutableArray * data;
@property (nonatomic, strong) HomeModel * homeModel;

@end

@implementation HomeRootController

- (void)viewDidLoad {
    [super viewDidLoad];
    self.navigationItem.title = @"捷友家";
    self.homeModel = [[HomeModel alloc] init];
    
    [self getNewData];
    [self initData];
    [self initNavigationBar];
    [self initTableView];
    [self initHeader];
    [self initFooterView];
    [self registerCells];
    
//    UIButton * button = [UIButton createButtonWithTitle:@"登录" color:[UIColor blackColor] font:kFont18 block:^(UIButton *button) {
//        UserLoginController * vc = [[UserLoginController alloc] init];
//        BaseNavigationController * nav = [[BaseNavigationController alloc] initWithRootViewController:vc];
//        [self presentViewController:nav animated:YES completion:nil];
//         }];
//    button.left = 100;
//    button.top = 100;
//    [self.view addSubview:button];
    
//    UIButton * button = [UIButton createMiddleBorderButtonWithTitle:@"登录" actionBolck:^(UIButton *button) {
//        button.enabled = NO;
//    }];
//    [self.view addSubview:button];
//    [button mas_makeConstraints:^(MASConstraintMaker *make) {
//        make.center.equalTo(self.view);
//    }];
}

#pragma mark - 初始化
- (void)getNewData
{
    [SortModel getAppFloorListWithBlock:^(id response, NSArray *sortList, NSError *error) {
        self.homeModel.sortList = sortList;
        for (SortModel * sortModel in sortList) {
            if ([sortModel.code isEqualToString:kBanner]) {
                [Banner getBannerListWithBlock:^(id response, NSArray *bannerList, NSError *error) {
                    self.homeModel.bannerList = bannerList;
                }];
            } else if ([sortModel.code isEqualToString:kActivity]) {
                [Banner getActivityListWithBlock:^(id response, NSArray *activityList, NSError *error) {
                    self.homeModel.activityList = activityList;
                }];
            } else if ([sortModel.code isEqualToString:kRecommend]) {
                [RecommendBanner getRecommendListWithBlock:^(id response, NSArray *recommendList, NSError *error) {
                    self.homeModel.recommendList = recommendList;
                }];
            }else if ([sortModel.code isEqualToString:kBrand]) {
                [ApartmentModel getApartmentListWithBlock:^(id response, NSArray *apartmentList, NSError *error) {
                    self.homeModel.apartmentList = apartmentList;
                }];
            }
        }
    }];
    
//    [Banner getBannerListWithBlock:^(id response, NSArray *bannerList, NSError *error) {
//        self.homeModel.bannerList = bannerList;
//    }];
//    
//    [Banner getActivityListWithBlock:^(id response, NSArray *activityList, NSError *error) {
//        self.homeModel.activityList = activityList;
//    }];
//    
//    [RecommendBanner getRecommendListWithBlock:^(id response, NSArray *recommendList, NSError *error) {
//        self.homeModel.recommendList = recommendList;
//    }];
//    
//    [ApartmentModel getApartmentListWithBlock:^(id response, NSArray *apartmentList, NSError *error) {
//        self.homeModel.apartmentList = apartmentList;
//    }];
}

- (void)initNavigationBar
{
    self.messageRemindView = [[MessageRemindView alloc] initWithFrame:CGRectMake(0, 0, kGeneralSize, kGeneralSize) iconName:@"tixing" target:self action:@selector(clickMessage)];
    self.messageRemindView.showMessageRemind = YES;
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc] initWithCustomView:self.messageRemindView];
    
    RegionSelectView * regionSelect = [RegionSelectView createRegionSelectViewWithFrame:CGRectMake(0, 0, 90, 44) actionBlock:^(UIButton *button) {
        DLog(@"选择区域");
    }];
    self.navigationItem.leftBarButtonItem = [[UIBarButtonItem alloc] initWithCustomView:regionSelect];
}

- (void)initTableView
{
    self.tableView = [[UITableView alloc] initWithFrame:CGRectMake(0, 0, self.view.width, self.view.height - kNavigationBarHeight - kStatusBarHeight - 49) style:UITableViewStyleGrouped];
    self.tableView.backgroundColor = [UIColor whiteColor];
    self.tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    self.tableView.sectionFooterHeight = 0;
    self.tableView.dataSource = self;
    self.tableView.delegate = self;
    [self.view addSubview:self.tableView];
}

- (void)initHeader
{
    NSMutableArray * bannerList = [NSMutableArray arrayWithCapacity:1];
    for (int i = 0; i < 3; i++) {
        Banner * banner = [[Banner alloc] init];
        banner.bannerUrl = [NSString stringWithFormat:@"%d", i + 1];
        [bannerList addObject:banner];
    }
    self.homeHeaderView = [[HomeHeaderView alloc] init];
    [self.homeHeaderView refreshWithBannerList:bannerList];
    self.tableView.tableHeaderView = self.homeHeaderView;
}

- (void)initFooterView
{
    UIView * footerView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, kScreenWidth, kAdaptiveBaseIphone6(87))];
    UIButton * footerButton = [UIButton createMiddleBorderButtonWithTitle:@"业主将房屋委托给捷友家" actionBolck:^(UIButton *button) {
        DLog(@"业主将房屋委托给捷友家");
        
        UserLoginController * vc = [[UserLoginController alloc] init];
        BaseNavigationController * nav = [[BaseNavigationController alloc] initWithRootViewController:vc];
        [self presentViewController:nav animated:YES completion:nil];
        
    }];
    [footerView addSubview:footerButton];
    [footerButton mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.equalTo(@(kAdaptiveBaseIphone6(8)));
        make.centerX.equalTo(footerView);
    }];
    
    self.tableView.tableFooterView = footerView;
}

- (void)reloadTableView
{
    [self initData];
    [self.tableView reloadData];
}

- (void)initData
{
    if (!self.data) {
        self.data = [NSMutableArray array];
    }
    
    if (!self.homeModel.sortList.count) {
        return;
    }
    [self.data removeAllObjects];
    NSMutableArray * bannerList = [NSMutableArray arrayWithCapacity:3];
    for (int i = 0; i < 3; i++) {
        Banner * banner = [[Banner alloc] init];
        banner.bannerUrl = [NSString stringWithFormat:@"%d", i + 1];
        [bannerList addObject:banner];
    }
    
    NSDictionary * dic1 = @{@"title" : @"精彩活动",
                            @"titleDetail" : @"更多",
                            @"class" : [HomeActivityCell class],
                            @"value" : bannerList,
                            @"height" : @(kHomeActivityCellHeight),
                            @"sel" : @""};
    
    NSMutableArray * bannerList1 = [NSMutableArray arrayWithCapacity:3];
    for (int i = 0; i < 3; i++) {
        RecommendBanner * banner = [[RecommendBanner alloc] init];
        banner.bannerUrl = [NSString stringWithFormat:@"%d", i + 1];
        [bannerList1 addObject:banner];
    }
    NSDictionary * dic2 = @{@"title" : @"推荐房源",
                            @"titleDetail" : @"更多",
                            @"class" : [HomeRecommentCell class],
                            @"value" : bannerList1,
                            @"height" : @(kHomeRecommentCellHeight),
                            @"sel" : @""};
    
    NSMutableArray * apartmentList = [NSMutableArray arrayWithCapacity:3];
    for (int i = 0; i < 3; i++) {
        ApartmentModel * apartment = [[ApartmentModel alloc] init];
        apartment.name = [NSString stringWithFormat:@"上海.小万达青果公寓%d", i];
        apartment.minPrice = [NSString stringWithFormat:@"¥190%d起", i];
        apartment.address = [NSString stringWithFormat:@"上海市松江区九亭镇岭南路65%d弄", i];
        apartment.picUrl = [NSString stringWithFormat:@"image%d", i];
        [apartmentList addObject:apartment];
    }
    
    NSDictionary * dic3 = @{@"title" : @"精品公寓",
                            @"titleDetail" : @"更多",
                            @"class" : [HomeApartmentCell class],
                            @"value" : apartmentList,
                            @"height" : @(kHomeApartmentCellHeight),
                            @"sel" : @"goToApartmentDetail:"};
    [self.data addObjectsFromArray:@[dic1, dic2, dic3]];
}

- (void)registerCells
{
    [self.tableView registerClass:[HomeActivityCell class] forCellReuseIdentifier:kHomeActivityCell];
    [self.tableView registerClass:[HomeRecommentCell class] forCellReuseIdentifier:kHomeRecommentCell];
    [self.tableView registerClass:[HomeApartmentCell class] forCellReuseIdentifier:kHomeApartmentCell];
}

#pragma mark - table view data source
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView
{
    return self.data.count;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    NSDictionary * dataDictionary = self.data[section];
    Class cellClass = dataDictionary[@"class"];
    if (cellClass == [HomeApartmentCell class]) {
        id value = dataDictionary[@"value"];
        if (isArray(value)) {
            NSArray * data = (NSArray *)value;
            return data.count;
        }
    }
    return 1;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    NSDictionary * dataDictionary = self.data[indexPath.section];
    Class cellClass = dataDictionary[@"class"];
    if (cellClass == [HomeActivityCell class]) {
        return [self getActivityCellWithIndexPath:indexPath];
    } else if (cellClass == [HomeRecommentCell class]) {
        return [self getRecommentCellWithIndexPath:indexPath];
    } else if (cellClass == [HomeApartmentCell class]) {
        return [self getApartmentCellWithIndexPath:indexPath];
    }
    return nil;
}

#pragma mark - 获取不同cell
- (UITableViewCell *)getActivityCellWithIndexPath:(NSIndexPath *)indexPath
{
    HomeActivityCell * cell = [self.tableView dequeueReusableCellWithIdentifier:kHomeActivityCell];
    cell.delegate = self;
//    cell.selectionStyle = UITableViewCellSelectionStyleNone;
    id value = self.data[indexPath.section][@"value"];
    if (isArray(value)) {
        NSArray * datas = (NSArray *)value;
        cell.data = datas;
    }
    return cell;
}

- (UITableViewCell *)getRecommentCellWithIndexPath:(NSIndexPath *)indexPath
{
    HomeRecommentCell * cell = [self.tableView dequeueReusableCellWithIdentifier:kHomeRecommentCell];
    cell.delegate = self;
//    cell.selectionStyle = UITableViewCellSelectionStyleNone;
    id value = self.data[indexPath.section][@"value"];
    if (isArray(value)) {
        NSArray * datas = (NSArray *)value;
        cell.data = datas;
    }
    return cell;
}

- (UITableViewCell *)getApartmentCellWithIndexPath:(NSIndexPath *)indexPath
{
    HomeApartmentCell * cell = [self.tableView dequeueReusableCellWithIdentifier:kHomeApartmentCell];
//    cell.selectionStyle = UITableViewCellSelectionStyleNone;
    id value = self.data[indexPath.section][@"value"];
    if (isArray(value)) {
        NSArray * datas = (NSArray *)value;
        cell.data = datas[indexPath.row];
    }
    return cell;
}

#pragma mark - table view delegate
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    CGFloat height = [self.data[indexPath.section][@"height"] floatValue];
    return height;
}

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section
{
    return kSectionHeight;
}

- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section
{
    NSDictionary * dataDictionary = self.data[section];
    Class cellClass = dataDictionary[@"class"];

    HomeSectionHeaderView * homeSectionHeader = [HomeSectionHeaderView getHomeSectionHeaderViewWithTitle:[self.data[section] valueForKey:@"title"] titleDetail:[self.data[section] valueForKey:@"titleDetail"]];
    homeSectionHeader.delegate = self;
    homeSectionHeader.classString = NSStringFromClass(cellClass);
    return homeSectionHeader;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    NSString * selName = [self.data[indexPath.section] valueForKey:@"sel"];
    SEL action = NSSelectorFromString(selName);
    if (action && [self respondsToSelector:action]) {
        [self performSelector:action withObject:indexPath afterDelay:0];
    }
}

#pragma mark - private methods
#pragma mark -- 点击section header代理方法
- (void)showMore:(HomeSectionHeaderView *)sectionHeaderView
{
    Class sectionClass = NSClassFromString(sectionHeaderView.classString);
    if ([sectionClass isSubclassOfClass:[HomeActivityCell class]]) {
        DLog(@"精彩活动");
    }  else if ([sectionClass isSubclassOfClass:[HomeRecommentCell class]]) {
        DLog(@"推荐房源");
    } else if ([sectionClass isSubclassOfClass:[HomeApartmentCell class]]) {
        DLog(@"精品公寓");
    } else {
        
    }
}

#pragma mark -- 点击消息中心方法
- (void)clickMessage
{
    self.messageRemindView.messageCount = 0;
    DLog(@"消息");
    BoundBankCardController * boundBankCardController = [[BoundBankCardController alloc] init];
    boundBankCardController.hidesBottomBarWhenPushed = YES;
    [self.navigationController pushViewController:boundBankCardController animated:YES];
}

- (void)goToApartmentDetail:(NSIndexPath *)indexPath
{
    
}

- (void)clickBannerView:(BannerView *)bannerView banner:(Banner *)banner
{
    
}

@end
